<dcs.Script>
	<dcdb.LoadRecord Table="dccCommSend" Id="$_Param.SendId" Result="SendData">
		<Select Field="Id" As="SendId" />
		<Select Field="dccUuid" As="Uuid" />
		<Select Field="dccPath" As="Path" />
		<Select Field="dccArgs" As="Args" />
		<SelectGroup Field="dccTrackerId" Key="Id" As="Tracker">
			<Select Field="dccTrackerDisplayName" As="DisplayName" />
			<Select Field="dccTrackerStatus" As="Status" />
			<Select Field="dccTrackerId" ForeignField="dccDisplayAddress" As="Address" />
		</SelectGroup>
	</dcdb.LoadRecord>

	<dcs.Info>send email background task: {$_Param.SendId} - {$SendData.Path}</dcs.Info>

	<dcs.Var Name="To" Type="List" />

	<dcs.ForEach Name="Tracker" In="$SendData.Tracker">
		<dcs.If Target="$Tracker.DisplayName" IsEmpty="false">
			<dcs.With Target="$To">
				<AddItem Value="{$Tracker.DisplayName} &lt;{$Tracker.Address}&gt;" />
			</dcs.With>
		</dcs.If>
		<dcs.Else>
			<dcs.With Target="$To">
				<AddItem Value="$Tracker.Address" />
			</dcs.With>
		</dcs.Else>
	</dcs.ForEach>

	<dcs.With Target="$SendData">
		<SetField Name="To" Value="{$To|join:; }" />
	</dcs.With>

	<dcs.Var Name="Comm" Type="dccCommAdapter">
		<BuildContent
			Channel="email"
			Request="$SendData"
			Result="MessageContent"
		/>
	</dcs.Var>

	<dcs.Info>content: {$MessageContent}</dcs.Info>

	<dcs.With Target="$SendData">
		<Merge Value="$MessageContent" />
	</dcs.With>

	<dcs.Info>content ext: {$SendData} -- {$MessageContent}</dcs.Info>

	<dcs.With Target="$Comm">
		<Deliver
			Channel="email"
			Request="$SendData"
			Result="DeliverInfo"
		/>
	</dcs.With>

	<dcs.Info>deliver: {$DeliverInfo}</dcs.Info>

	<dcs.Exit Scope="Task" />
</dcs.Script>
