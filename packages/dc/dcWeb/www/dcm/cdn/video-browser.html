<dc.Html Badges="User">
	<Meta Name="Title">
		<Tr Locale="eng" Value="Videos Browser" />
	</Meta>

	<Require Script="/js/dc.transfer.js" />
	<Require Script="/js/vendor/jquery.fileDownload.js" />

	<dcs.With Target="$_Resources.Mime">
	  <GetMimeDeep Result="Mimes" />
	</dcs.With>

	<dcs.CatalogSettings Id="Interchange-Aws" Result="AwsConfig" />

	<dc.Body>
		<div style="display: none;">
			<dc.Icon Path="far/folder" />
			<dc.Icon Path="far/file" />

			<dcs.ForEach Name="Mime" In="$Mimes">
				<dcs.If Target="$Mime.Icon" IsEmpty="false">
					<dc.Out>
						<dc.Icon Path="{$Mime.Icon}" />
					</dc.Out>
				</dcs.If>
			</dcs.ForEach>
		</div>

		<dc.Style>
.dcm-file-list {
	display: flex;
	flex-direction: row;
	flex-wrap: wrap;
	justify-content: flex-start;
	align-content: stretch;
	align-items: flex-start;
}

.dcm-file-list a.dc-selected {
	background-color: #e8f0fe;
}

.dcm-file-list a.dcm-file {
	width: 152px;
	margin: 1.2rem;
}

.dcm-file-list a.dcm-file svg {
	font-size: 96px;
	padding: 0 16px;
	color: black;
}

.dcm-file-list div.dcm-file-title {
	padding: .8rem 1.2rem;
	text-overflow: ellipsis;
	white-space: nowrap;
	font-size: 1.3rem;
	overflow: hidden;
	text-align: center;
}

.dcm-file-list a.dcm-folder {
	margin: 1.6rem;
	width: 152px;
	border: 1px solid darkgray;
	border-radius: 3px;
	box-shadow: 0 1px 1px 0 rgba(0,0,0,.2);
}

.dcm-file-list a.dcm-folder svg {
	padding-right: 6px;
	color: black;
}

#btnDepCdnSelectAction {
	display: none;
}
		</dc.Style>

		<dc.PagePanel>
			<dcs.CatalogSettings Id="Interchange-Aws" Result="AwsConfig" />

			<dcs.If Target="$AwsConfig.@VideoBucket" IsEmpty="false">
				<dc.Out>
					<h2 class="dc-element-hidden">Options</h3>

					<dcf.FormButtons>
						<dc.Button id="btnDepCdnSelectAction" Click="DoSelect" Label="Select File(s)" />
						<dc.Button Click="DoUpload" Label="Upload File" />
						<dc.Button Click="DoAddFolder" Label="Add Folder" />
						<dc.Button Click="DoOptions" Label="Options ..." />
					</dcf.FormButtons>

					<h2 id="lblDepCdnPath" />

					<h2>Folders</h3>

					<div id="lstDepCdnFolders" class="dcm-file-list" />

					<h2>Files</h3>

					<div id="lstDepCdnFiles" class="dcm-file-list" />
				</dc.Out>
			</dcs.If>
			<dcs.Else>
				<dc.Out>
					<p>Your website does not have a CDN configured, please ask your web developer to assist.</p>
				</dc.Out>
			</dc.Else>
		</dc.PagePanel>
	</dc.Body>
	<Function Name="Load"><![CDATA[
			var entry = this;

			entry.Store.MimeDefs = {$Mimes};

			if (! this.Store.Path) {
				if (this.Params.Path) {
					entry.Store.Path = this.Params.Path;
				}
				else {
					var lastPath = localStorage.getItem('dcCMS-CDNVideos-LastFolder');
					entry.Store.Path = lastPath || '/';
				}
			}

			entry.Store.PublicPath = 'https://{$AwsConfig.@CDNDomain}/{$_Node.Deployment}/{$_Tenant.Alias}/videos';

			var npos = entry.Name.lastIndexOf('/');
			var nname = entry.Name.substr(npos + 1);

			entry.Store.Menus = {
				dcmDepCdnFileMenu: {
					Options: [
						{
							Title: 'Preview',
							Op: function(e) {
								var files = entry.callPageFunc('GetSelectedFiles');

								entry.callPageFunc('DoPreview', files[0]);
							}
						},
						{
							Title: 'Delete',
							Auth: [ 'Admin', 'Editor' ],
							Op: function(e) {
								var files = entry.callPageFunc('GetSelectedFiles');

								entry.callPageFunc('DoDelete', files);
							}
						},
						{
							Title: 'Refresh',
							Op: function(e) {
								entry.callPageFunc('DoRefresh');
							}
						},
						{
							Title: 'Copy Link',
							Op: function(e) {
								var files = entry.callPageFunc('GetSelectedFiles');

						    var input = document.createElement("textarea");

								$(input).addClass('dc-element-hidden');

								document.body.appendChild(input);

						    input.value = entry.Store.PublicPath + files[0].Path + '.hls/' + files[0].VideoIndex;
						    input.select();

						    document.execCommand("Copy");

						    input.remove();
							}
						},
						{
							Title: 'Copy Thumb Link',
							Op: function(e) {
								var files = entry.callPageFunc('GetSelectedFiles');

						    var input = document.createElement("textarea");

								$(input).addClass('dc-element-hidden');

								document.body.appendChild(input);

						    input.value = entry.Store.PublicPath + files[0].Path + '.hls/' + files[0].Thumbnail;
						    input.select();

						    document.execCommand("Copy");

						    input.remove();
							}
						}
					]
				},
				dcmDepCdnFilesMenu: {
					Options: [
						{
							Title: 'Refresh',
							Op: function(e) {
								entry.callPageFunc('DoRefresh');
							}
						},
						{
							Title: 'Delete',
							Auth: [ 'Admin', 'Editor' ],
							Op: function(e) {
								var files = entry.callPageFunc('GetSelectedFiles');

								entry.callPageFunc('DoDelete', files);
							}
						}
					]
				},
				dcmDepCdnEmptyMenu: {
					Options: [
						{
							Title: 'Refresh',
							Op: function(e) {
								entry.callPageFunc('DoRefresh');
							}
						}
					]
				}
			};

			this.callPageFunc('LoadList');

			if (entry.Params.SelectMode)
				$('#btnDepCdnSelectAction').show();
	]]></Function>
	<Function Name="LoadList"><![CDATA[
			var entry = this;

			$('#lblDepCdnPath').text('Path: ' + entry.Store.Path);

			localStorage.setItem('dcCMS-CDNVideos-LastFolder', entry.Store.Path);

			$('#lstDepCdnFolders,#lstDepCdnFiles').empty();

			dc.comm.call('dcmServices.CDN.VideoListFolder', { Path: entry.Store.Path }, function(resp) {
				if (resp.Code > 0) {
					dc.pui.Popup.alert(resp.Message);
					return;
				}

				var items = entry.Store.Items = resp.Result;
				var sfield = entry.Store.SortField ? entry.Store.SortField : 'FileName';

				// sort
				items.sort(dc.util.List.sortObjects(sfield));

				// ########## FOLDERS ##########

				var flist = $('#lstDepCdnFolders');

				var folderUpFunc = function(e) {
					var curr = entry.Store.Path;

					if (curr.length == 1)
						return;

					var path = curr.substr(0, curr.lastIndexOf('/'));

					if (!path)
						path = '/';

					entry.Store.Path = path;
					entry.callPageFunc('LoadList');

					e.preventDefault();
					return false;
				};

				// add parent folder
				if (entry.Store.Path.length > 1) {
					flist.dcappend($('<a>')
						.attr('href', '#')
						.addClass('dcm-folder')
						.dblclick(folderUpFunc)
						.dcappend($('<div>')
						 	.addClass('dcm-file-title')
							.dcappend(
								dc.util.Icon.use('far-folder')
									.addClass('fa5-lg fa5-fw'),
								' .. [parent]'
							)
						)
					);
				}

				var fileHighlightFunc = function(e) {
					if (! e.ctrlKey)
						$('#lstDepCdnFolders a, #lstDepCdnFiles a').not(e.currentTarget).removeClass('dc-selected');

					$(e.currentTarget).toggleClass('dc-selected');

					e.preventDefault();
					return false;
				};

				var folderDownFunc = function(e) {
					var path = '/' + e.data.FileName;

					if (entry.Store.Path.length > 1)
						path = entry.Store.Path + '/' + e.data.FileName;

					entry.Store.Path = path;
					entry.callPageFunc('LoadList');

					e.preventDefault();
					return false;
				};

				// assign id
				for (var i = 0; i < items.length; i++) {
					items[i].InternalUuid = dc.util.Uuid.create();
				}

				// display
				for (var i = 0; i < items.length; i++) {
					var item = items[i];

					if (entry.Params.Chained || ! item.IsFolder)
						continue;

					item.Path = '/' + item.FileName;

					if (entry.Store.Path.length > 1)
						item.Path = entry.Store.Path + '/' + item.FileName;

					flist.dcappend($('<a>')
						.attr('href', '#')
						.attr('data-id', item.InternalUuid)
						.addClass('dcm-folder')
						.click(item, fileHighlightFunc)
						.dblclick(item, folderDownFunc)
						.dcappend($('<div>')
						 	.addClass('dcm-file-title')
							.dcappend(
								dc.util.Icon.use('far-folder')
									.addClass('fa5-lg fa5-fw'),
								' ',
								item.FileName
							)
						)
					);
				}

				// ########## FILES ##########

				var flist = $('#lstDepCdnFiles');

				var fileClickFunc = function(e) {
					entry.callPageFunc('DoPreview', e.data);

					e.preventDefault();
					return false;
				};

				// display
				for (var i = 0; i < items.length; i++) {
					var item = items[i];

					if (item.IsFolder)
						continue;

					var icon = 'far/file';

					if (item.FileName.indexOf('.') != -1) {
						var fext = item.FileName.substr(item.FileName.lastIndexOf('.')).toLowerCase();

						if (fext.length > 1)
							fext = fext.substr(1);

						for (var m = 0; m < entry.Store.MimeDefs.length; m++) {
							var def = entry.Store.MimeDefs[m];

							if (def.Ext == fext) {
								if (def.Icon)
									icon = def.Icon;

								break;
							}
						}
					}

					item.Path = '/' + item.FileName;

					if (entry.Store.Path.length > 1)
						item.Path = entry.Store.Path + '/' + item.FileName;

					// dc.transfer.fmtFileSize(item.Size)
					// dc.util.Date.formatZLocalMedium(item.LastModified)

					flist.append($('<a>')
						.attr('href', '#')
						.addClass('dcm-file')
						.attr('data-id', item.InternalUuid)
						.attr('title', item.FileName)
						.click(item, fileHighlightFunc)
						.dblclick(item, fileClickFunc)
						.dcappend(
							dc.util.Icon.use(icon.replace('/', '-'))
								.addClass('fa5-lg fa5-fw'),
							$('<div>')
							 	.addClass('dcm-file-title')
								.text(item.FileName)
						)
					);
				}

			});
	]]></Function>
	<Function Name="DoPreview" Params="file"><![CDATA[
			var entry = this;

			dc.pui.FullScreen.loadPage('/dcw/view-streaming-video', {
				Url: entry.Store.PublicPath + file.Path + '.hls/' + file.VideoIndex,
				Poster: entry.Store.PublicPath + file.Path + '.hls/' + file.Thumbnail
			});
	]]></Function>
	<Function Name="DoOptions"><![CDATA[
			var page = this;

			var filecnt = $('#lstDepCdnFolders a.dc-selected,#lstDepCdnFiles a.dc-selected').length;

			if (filecnt > 1)
				dc.pui.Popup.menu(page.Store.Menus.dcmDepCdnFilesMenu);
			else if (filecnt == 1)
				dc.pui.Popup.menu(page.Store.Menus.dcmDepCdnFileMenu);
			else
				dc.pui.Popup.menu(page.Store.Menus.dcmDepCdnEmptyMenu);
	]]></Function>
	<Function Name="DoDelete" Params="files"><![CDATA[
			var page = this;

			var paths = [ ];

			for (var i = 0; i < files.length; i++) {
				paths.push(page.Store.Path + '/' + files[i].FileName + '.hls');   // indicate that this is a folder to delete

				// TODO restore when folders work - paths.push(page.Store.Path + '/' + files[i].FileName + '.ready');
			}

			dc.pui.Popup.confirm('Are you sure you want to remove selected videos and folders?', function(confirm) {
				if (! confirm)
					return;

				dc.comm.call('dcmServices.CDN.VideoDeleteFiles', {
						Paths: paths
					}, function(resp) {
						if (resp.Code > 0)
							dc.pui.Popup.alert(resp.Message);
						else
							// take time for delete to register in S3
							setTimeout(function() { page.callPageFunc('LoadList'); }, 1000);
					});
			});
	]]></Function>
	<Function Name="GetSelectedFiles"><![CDATA[
			var entry = this;

			var list = [ ];

			$('#lstDepCdnFolders a.dc-selected,#lstDepCdnFiles a.dc-selected').each(function() {
				var iuuid = $(this).attr('data-id');

				for (var n = 0; n < entry.Store.Items.length; n++) {
					if (entry.Store.Items[n].InternalUuid == iuuid) {
						list.push(entry.Store.Items[n]);
					}
				}
			});

			return list;
	]]></Function>
	<Function Name="DoRefresh"><![CDATA[
			this.callPageFunc('LoadList');
	]]></Function>
	<Function Name="DoClose"><![CDATA[
			var entry = this;

			entry.Layer.back();
	]]></Function>
	<Function Name="DoAddFolder"><![CDATA[
			var entry = this;

			dc.pui.Dialog.loadPage('/dcm/cdn/video-add-folder', {
				Path: entry.Store.Path,
				Callback: function(path) {
					entry.Store.Path = path;

					entry.callPageFunc('LoadList');
				}
			});
	]]></Function>
	<Function Name="DoUpload"><![CDATA[
			var entry = this;

			dc.pui.Dialog.loadPage('/dcm/cdn/video-upload-file', {
				Path: entry.Store.Path,
				Callback: function(files) {
					if (entry.Params.Callback) {
						entry.Layer.back();
						entry.Params.Callback(files);
					}
					else {
						$('#lstDepCdnFolders,#lstDepCdnFiles').empty().dcappend(
							$('<i>')
								.attr('class', 'fa fa-spinner fa-pulse fa-lg')
						);

						entry.callPageFunc('LoadList');
					}
				}
			});
	]]></Function>
	<Function Name="DoSelect"><![CDATA[
			var entry = this;

			var files = entry.callPageFunc('GetSelectedFiles');

			var results = [ ];

			for (var i = 0; i < files.length; i++)
				results.push(entry.Store.PublicPath + files[i].Path + '.hls/' + files[i].VideoIndex);

			entry.Layer.back();

			if (entry.Params.Callback)
				entry.Params.Callback(results);
	]]></Function>
</dc.Html>
