<dc.Html AuthTags="Admin,Editor">
	<Meta Name="Title">
		<Tr Locale="en" Value="Gallery Widget List" />
	</Meta>

	<Require Script="/js/vendor/sortable.min.js" />

	<dc.Body>
		<dc.PagePanel>
			<div class="formbuttons">
				<dc.Button Click="DoSelectImage" Label="Select Image From Gallery" />
				<dc.Button Click="DoAddImage" Label="Upload New Image" />
				<dc.Button Click="DoSaveShow" Label="Save" Scope="Primary" />
			</div>

			<div id="imageDesEList" class="dc-pui-sortable dcm-file-list" />
		</dc.PagePanel>
	</dc.Body>
	<Function Name="Load"><![CDATA[
			var entry = this;

			var list = $('#imageDesEList');

			entry.Store.SortTime = null;

			var sortable = Sortable.create(list.get(0), {
			    onEnd: function (evt) {
			        entry.Store.Changed = true;

			        entry.callPageFunc('ReorderImages');
			    }
		    });

			list.empty();
			list.append('<li><h3><i class="fa fa-spinner fa-spin"></i></h3></li>');

			// first time load
			if (! entry.Params.Path) {
				var cparams = dc.pui.App.Context.Params;

				if (cparams && cparams.Show) {
					entry.Params.Path = cparams.Show.Path;
					entry.Params.Alias = cparams.Show.Alias;
				}
			}

			entry.Store.Changed = false;
			entry.Store.Show = null;			// obj from within settings
			entry.Store.CurrImage = null;		// obj from within show

			entry.Store.Params = dc.pui.App.Context.Params;

			var iloaded = function(gallery, resp) {
				if (resp && resp.Result > 0) {
					dc.pui.Popup.alert(resp.Message);
					return;
				}

				entry.Store.Gallery = gallery;

				if (entry.Store.Params.GalleryShow)
					entry.Store.Show = entry.Store.Gallery.findShow(entry.Store.Params.GalleryShow);

				if (entry.Store.Show && ! entry.Store.Show.Images)
					entry.Store.Show.Images = [];

				entry.callPageFunc('RefreshImages');
			};

			// load Gallery when missing parameter
			dc.cms.image.Loader.loadGallery(entry.Store.Params.GalleryPath, iloaded);
	]]></Function>
	<Function Name="Freeze">
			var entry = this;

			// TODO store gallery order
	</Function>
	<Function Name="RefreshImages"><![CDATA[
			var entry = this;

			var list = $('#imageDesEList');
			list.empty();

			if (entry.Store.Show) {
				for (var i = 0; i < entry.Store.Show.Images.length; i++) {
					var img = entry.Store.Show.Images[i];

					var litm = $('<a href="#" class="dcm-file"></a>');

					litm.attr('data-img-alias', img);

					var path = '/galleries' + entry.Store.Params.GalleryPath + '/' + img;

					var imgel = $('<img src="/imgs/dots.png" />');

					litm.append(imgel);

					// to keep the scope of imgel, make function
					var lfunc = function(path, imgel) {
						dc.util.Image.load(path + '.v/thumb.jpg',
							function(img) {
								if (img)
									imgel.attr('src', img.src);
								else
									imgel.attr('src', '/imgs/question.png');
							});
					};

					lfunc(path, imgel);

					var itmtitle = $('<div class="dcm-file-title"></div>');
					itmtitle.text(img);
					litm.append(itmtitle);

					litm.click(img, function(e) {
					    //	console.log('xyz');

					    if (entry.Store.SortTime) {
					    	if (new Date().getTime() - entry.Store.SortTime.getTime() < 500) {
						    	entry.Store.SortTime = null;
						    	return;
						    }
					    }

						var pageurl = entry.Store.Gallery.Meta.PropertyEditor
										? entry.Store.Gallery.Meta.PropertyEditor : '/dcm/shows/edit-image';

						dc.pui.Dialog.loadPage(pageurl, {
							Image: e.data,
							Show: entry.Store.Show,
							Gallery: entry.Store.Gallery
						});

						e.preventDefault();
						return false;
					});

					list.append(litm);
				}
			}
	]]></Function>
	<Function Name="ReorderImages"><![CDATA[
			var entry = this;

			var oldimages = entry.Store.Show.Images;
			entry.Store.Show.Images = [];

			$('#imageDesEList > a').each(function(i) {
				var calias = $(this).attr('data-img-alias');

				var calias = $(this).attr('data-img-alias');
				entry.Store.Show.Images.push(calias);
			});
	]]></Function>
	<Function Name="DoSaveShow"><![CDATA[
			var entry = this;

			entry.Store.Gallery.updateShow(entry.Store.Show);

			entry.Store.Gallery.save(function(resp) {
				if (resp.Result > 0)
					dc.pui.Popup.alert(resp.Message);
				else
					dc.pui.Popup.alert('Show saved');
			});
	]]></Function>
	<Function Name="DoSelectImage"><![CDATA[
			var entry = this;

			dc.pui.Dialog.loadPage('/dcm/galleries/chooser', {
				Path: entry.Params.Path,
				Chained: true,
				Variation: entry.Store.Show.Variation,
				Callback: function(res) {
					if (res.Images) {
						for (var i = 0; i < res.Images.length; i++) {
							entry.Store.Show.Images.splice(i, 0, {
								Alias: res.Images[i].FileName
							});
						}
					}

					entry.callPageFunc('RefreshImages');
				}
			});
	]]></Function>
	<Function Name="DoAddImage"><![CDATA[
			var entry = this;

			dc.pui.Dialog.loadPage('/dcm/galleries/quick-upload', {
				Gallery: entry.Store.Gallery,
				Variation: entry.Store.Show.Variation,
				Callback: function(files) {				// just a list of names
					if (files) {
						for (var i = 0; i < files.length; i++)
							entry.Store.Show.Images.splice(i, 0, {
								Alias: files[i].FileName
							});
					}

					entry.callPageFunc('RefreshImages');
				}
			});
	]]></Function>
</dc.Html>
