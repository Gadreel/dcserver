<dc.Html Badges="Admin,Editor">
	<Meta Name="Title">
		<Tr Locale="en" Value="Image Widget Template" />
	</Meta>

	<Require Script="/js/vendor/ace-1.1.8/ace.js" />

	<dc.Body>
		<dc.PagePanel>
			<dcf.FormButtons>
				<dc.Button Click="DoSave" Label="Save" Scope="Primary" />
			</dcf.FormButtons>

			<!-- TODO create editor control -->
			<div id="sectDepEscEdit" style="position: absolute; top: 10rem; left: 0; right: 0; bottom: 0;" />
		</dc.PagePanel>
	</dc.Body>
	<Function Name="Load">
			var entry = this;

			entry.Store.Changed = false;
			entry.Store.SetMode = false;
			entry.Store.Editor = ace.edit('sectDepEscEdit');
			entry.Store.Params = dc.pui.App.Context.Params;

			var editor = entry.Store.Editor;

			editor.setTheme("ace/theme/chrome");
			editor.getSession().setMode("ace/mode/xml");
			editor.setShowPrintMargin(false);
			editor.getSession().setTabSize(5);
			editor.getSession().setUseSoftTabs(false);
			editor.getSession().setUseWrapMode(true);

			editor.on("change", function() {
				if (! entry.Store.SetMode)
					entry.Store.Changed = true;
			});

			if (dc.pui.App.Context.IsNew || entry.Store.Params.Template) {
				entry.Store.SetMode = true;

				if (entry.Store.Params.Template)
					editor.setValue(entry.Store.Params.Template, -1);

				entry.Store.SetMode = false;

				entry.Store.Editor.focus();
			}
			else {
				var msg = {
					Service: 'dcCoreServices',
					Feature: 'Vaults',
					Op: 'Custom',
					Body: {
						Vault: 'Feeds',
						Command: 'LoadPart',
						Path: '/' + entry.Store.Params.Feed + entry.Store.Params.Path,
						Params: {
							PartId: entry.Store.Params.Id,
							Mode: 'text',
							PartPath: '_'	// inner only
						}
					}
				};

				if (dc.handler.dcmVersion == '2018') {
					msg = {
						Service: 'dcmServices',
						Feature: 'Feed',
						Op: 'LoadPart',
						Body: {
							Feed: entry.Store.Params.Feed,
							Path: entry.Store.Params.Path,
							PartId: entry.Store.Params.Id
						}
					};
				}

				dc.comm.sendMessage(, function(rmsg) {
					if (rmsg.Result != 0) {
						dc.pui.Popup.alert(rmsg.Message);
						return;
					}

					var template = (dc.handler.dcmVersion == '2018') ? rmsg.Body.Part : rmsg.Body.Extra;

					entry.Store.SetMode = true;

					editor.setValue(template, -1);

					entry.Store.SetMode = false;

					entry.Store.Editor.focus();
				});
			}
    </Function>
	<Function Name="Freeze">
			var entry = this;

			if (entry.Store.Editor)
				entry.Store.Params.Template = entry.Store.Editor.getValue();
	</Function>
	<Function Name="DoSave">
			var entry = this;

			// remember the content
			var template = entry.Store.Params.Template = entry.Store.Editor.getValue();

			var msg = {
				Service: 'dcCoreServices',
				Feature: 'Vaults',
				Op: 'Custom',
				Body: {
					Vault: 'Feeds',
					Command: 'SavePart',
					Path: '/' + entry.Store.Params.Feed + entry.Store.Params.Path,
					Params: {
						PartId: entry.Store.Params.Id,
						PartPath: '_',	// inner only
						Mode: 'text',
						Part: template
					}
				}
			};

			if (dc.handler.dcmVersion == '2018') {
				e.Message = {
					Service: 'dcmServices',
					Feature: 'Feed',
					Op: 'AddCommandHistory',
					Body: {
						Feed: entry.Store.Params.Feed,
						Path: entry.Store.Params.Path,
						Commands: [
							{
								Command: 'SavePart',
								Params: {
									PartId: entry.Store.Params.Id,
									Part: widget
								}
							}
						]
					}
				};
			}

			dc.comm.sendMessage(msg, function(rmsg) {
				if (rmsg.Result != 0)
					dc.pui.Popup.alert(rmsg.Message);
				else
					dc.pui.Popup.alert('Saved');
			});
	</Function>
	<Function Name="onDestroy">
			var entry = this;

			if (entry.Store.Editor) {
				entry.Store.Editor.destroy();
				delete entry.Store.Editor;
			}
	</Function>
</dc.Html>
